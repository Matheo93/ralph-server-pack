(()=>{var e=[,(e,t,n)=>{var o=n(2);e.exports=function(e,t,n){return(t=o(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.__esModule=!0,e.exports.default=e.exports},(e,t,n)=>{var o=n(3).default,a=n(4);e.exports=function(e){var t=a(e,"string");return"symbol"==o(t)?t:t+""},e.exports.__esModule=!0,e.exports.default=e.exports},e=>{function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},(e,t,n)=>{var o=n(3).default;e.exports=function(e,t){if("object"!=o(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=o(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)},e.exports.__esModule=!0,e.exports.default=e.exports}],t={};function n(o){var a=t[o];if(void 0!==a)return a.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}(()=>{var e=n(1);function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,o)}return n}function o(n){for(var o=1;o<arguments.length;o++){var a=null!=arguments[o]?arguments[o]:{};o%2?t(Object(a),!0).forEach(function(t){e(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))})}return n}const a="offline-fallback-v1",r="familyload-dynamic-v1",i=["/offline.html","/icons/icon-192.png","/icons/icon-72.png","/manifest.json"];function s(){return new Promise((e,t)=>{const n=indexedDB.open("familyload-offline",1);n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("api-cache")){const e=t.createObjectStore("api-cache",{keyPath:"url"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}if(!t.objectStoreNames.contains("offline-tasks")){const e=t.createObjectStore("offline-tasks",{keyPath:"id"});e.createIndex("household_id","household_id",{unique:!1}),e.createIndex("synced","synced",{unique:!1})}if(!t.objectStoreNames.contains("sync-queue")){const e=t.createObjectStore("sync-queue",{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("operation","operation",{unique:!1})}t.objectStoreNames.contains("user-data")||t.createObjectStore("user-data",{keyPath:"key"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function c(e,t,n="general"){try{const o=await s(),a=o.transaction("api-cache","readwrite").objectStore("api-cache");await a.put({url:e,data:t,type:n,timestamp:Date.now()}),o.close()}catch(e){console.error("[SW] Failed to cache API response:",e)}}async function l(){try{const e=await s(),t=e.transaction("offline-tasks","readonly").objectStore("offline-tasks");return new Promise((n,o)=>{const a=t.getAll();a.onsuccess=()=>{e.close(),n(a.result)},a.onerror=()=>{e.close(),o(a.error)}})}catch(e){return console.error("[SW] Failed to get offline tasks:",e),[]}}async function d(e){try{const t=await s(),n=t.transaction("offline-tasks","readwrite").objectStore("offline-tasks"),o=await new Promise((t,o)=>{const a=n.get(e);a.onsuccess=()=>t(a.result),a.onerror=()=>o(a.error)});o&&(o.synced=!0,await n.put(o)),t.close()}catch(e){console.error("[SW] Failed to mark task as synced:",e)}}async function u(e){try{const t=await s(),n=t.transaction("sync-queue","readwrite").objectStore("sync-queue");await n.delete(e),t.close()}catch(e){console.error("[SW] Failed to remove from sync queue:",e)}}async function f(e=6048e5){try{const t=await s(),n=t.transaction("api-cache","readwrite").objectStore("api-cache"),o=n.index("timestamp"),a=Date.now()-e,r=IDBKeyRange.upperBound(a);o.openCursor(r).onsuccess=e=>{const t=e.target.result;t&&(n.delete(t.primaryKey),t.continue())},t.close()}catch(e){console.error("[SW] Failed to clear old cache:",e)}}async function p(){try{const e=await async function(){try{const e=await s(),t=e.transaction("sync-queue","readonly").objectStore("sync-queue");return new Promise((n,o)=>{const a=t.getAll();a.onsuccess=()=>{e.close(),n(a.result)},a.onerror=()=>{e.close(),o(a.error)}})}catch(e){return console.error("[SW] Failed to get sync queue:",e),[]}}();for(const t of e)try{let e;const n=self.location.origin;switch(t.operation){case"create":e=await fetch(`${n}/api/v2/${t.entity}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data),credentials:"include"});break;case"update":e=await fetch(`${n}/api/v2/${t.entity}/${t.data.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data),credentials:"include"});break;case"delete":e=await fetch(`${n}/api/v2/${t.entity}/${t.data.id}`,{method:"DELETE",credentials:"include"})}if(e&&e.ok){await u(t.id);(await clients.matchAll()).forEach(e=>{e.postMessage({type:"SYNC_COMPLETE",item:t})})}}catch(e){console.error("[SW] Sync failed for item:",t.id)}}catch(e){console.error("[SW] Sync queue processing failed:",e)}}async function y(){try{const e=(await l()).filter(e=>!e.synced);for(const t of e)try{const e=await fetch(`${self.location.origin}/api/v2/tasks`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,description:t.description,priority:t.priority,category:t.category,due_date:t.due_date,household_id:t.household_id}),credentials:"include"});if(e.ok){const n=await e.json();await d(t.id);const o=await clients.matchAll();for(const e of o)e.postMessage({type:"TASK_SYNCED",offlineId:t.id,serverData:n})}}catch(e){console.error("[SW] Failed to sync task:",t.id)}}catch(e){console.error("[SW] Offline task sync failed:",e)}}async function h(){try{const e=["/api/v2/tasks?limit=50","/api/v2/household"];for(const t of e)try{const e=await fetch(`${self.location.origin}${t}`,{credentials:"include"});if(e.ok){const n=await e.json();await c(t,n,"critical")}}catch(e){}await f()}catch(e){}}self.addEventListener("message",e=>{e.data&&"SKIP_WAITING"===e.data.type&&self.skipWaiting(),e.data&&"CLEAR_CACHE"===e.data.type&&(caches.keys().then(e=>{e.forEach(e=>caches.delete(e))}),f(0)),e.data&&"SAVE_OFFLINE_TASK"===e.data.type&&async function(e){try{const t=await s(),n=t.transaction("offline-tasks","readwrite").objectStore("offline-tasks");return await n.put(o(o({},e),{},{id:e.id||`offline_${Date.now()}_${Math.random().toString(36).slice(2)}`,synced:!1,created_offline:!0,timestamp:Date.now()})),t.close(),!0}catch(e){return console.error("[SW] Failed to save offline task:",e),!1}}(e.data.task).then(t=>{e.ports&&e.ports[0]&&e.ports[0].postMessage({success:t})}),e.data&&"GET_OFFLINE_TASKS"===e.data.type&&l().then(t=>{e.ports&&e.ports[0]&&e.ports[0].postMessage({tasks:t})})}),self.addEventListener("push",e=>{if(e.data)try{const t=e.data.json(),n={body:t.body||"Vous avez une nouvelle notification",icon:"/icons/icon-192.png",badge:"/icons/icon-72.png",vibrate:[100,50,100],tag:t.tag||"familyload-notification",renotify:!0,requireInteraction:t.requireInteraction||!1,data:o({url:t.url||"/dashboard"},t.data),actions:t.actions||[{action:"view",title:"Voir"},{action:"dismiss",title:"Ignorer"}]};e.waitUntil(self.registration.showNotification(t.title||"FamilyLoad",n))}catch(t){const n=e.data.text();e.waitUntil(self.registration.showNotification("FamilyLoad",{body:n,icon:"/icons/icon-192.png",badge:"/icons/icon-72.png"}))}}),self.addEventListener("notificationclick",e=>{var t;e.notification.close();const n=(null===(t=e.notification.data)||void 0===t?void 0:t.url)||"/dashboard";"dismiss"!==e.action&&e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(e=>{for(const t of e)if("focus"in t)return t.focus().then(e=>{if("navigate"in e)return e.navigate(n)});if(clients.openWindow)return clients.openWindow(n)}))}),self.addEventListener("sync",e=>{"background-sync"===e.tag&&e.waitUntil(p()),"sync-offline-tasks"===e.tag&&e.waitUntil(y())}),self.addEventListener("periodicsync",e=>{"periodic-sync"===e.tag&&e.waitUntil(async function(){await p(),await y(),await h()}()),"refresh-data"===e.tag&&e.waitUntil(h())}),self.addEventListener("install",e=>{e.waitUntil(caches.open(a).then(e=>e.addAll(i)))}),self.addEventListener("activate",e=>{e.waitUntil(Promise.all([caches.keys().then(e=>Promise.all(e.filter(e=>!(!e.startsWith("offline-fallback-")||e===a)||!(!e.startsWith("familyload-dynamic-")||e===r)).map(e=>caches.delete(e)))),self.clients.claim()]))}),self.addEventListener("fetch",e=>{const t=new URL(e.request.url);"GET"===e.request.method?t.pathname.startsWith("/api/")?e.respondWith(async function(e){const t=new URL(e.url);try{const n=await fetch(e);if(n.ok){const e=await n.clone().json();await c(t.pathname+t.search,e,"api")}return n}catch(e){const n=await async function(e){try{const t=await s(),n=t.transaction("api-cache","readonly").objectStore("api-cache");return new Promise((o,a)=>{const r=n.get(e);r.onsuccess=()=>{t.close(),o(r.result)},r.onerror=()=>{t.close(),a(r.error)}})}catch(e){return console.error("[SW] Failed to get cached API response:",e),null}}(t.pathname+t.search);return n?new Response(JSON.stringify(n.data),{status:200,headers:{"Content-Type":"application/json","X-Cache-Status":"offline","X-Cache-Timestamp":n.timestamp.toString()}}):new Response(JSON.stringify({error:"Offline",message:"Vous êtes hors ligne et ces données ne sont pas en cache.",offline:!0}),{status:503,headers:{"Content-Type":"application/json"}})}}(e.request)):"navigate"!==e.request.mode||e.respondWith(async function(e){try{return await fetch(e)}catch(t){const n=await caches.open(r),o=await n.match(e);if(o)return o;const i=await caches.open(a),s=await i.match("/offline.html");return s||new Response('<!DOCTYPE html>\n<html lang="fr">\n<head>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1">\n  <title>Hors ligne - FamilyLoad</title>\n  <style>\n    body { font-family: system-ui, sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background: #f8fafc; }\n    .container { text-align: center; padding: 2rem; }\n    h1 { color: #1e293b; margin-bottom: 1rem; }\n    p { color: #64748b; margin-bottom: 1.5rem; }\n    button { background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; }\n    button:hover { background: #2563eb; }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <h1>Vous êtes hors ligne</h1>\n    <p>Vérifiez votre connexion internet et réessayez.</p>\n    <button onclick="window.location.reload()">Réessayer</button>\n  </div>\n</body>\n</html>',{headers:{"Content-Type":"text/html; charset=utf-8"}})}}(e.request)):navigator.onLine||"GET"===e.request.method||e.respondWith(async function(e){try{const t=await e.clone().json(),n=new URL(e.url).pathname.split("/").filter(Boolean),o=n[n.length-1];return await async function(e,t,n){try{const o=await s(),a=o.transaction("sync-queue","readwrite").objectStore("sync-queue");await a.add({operation:e,entity:t,data:n,timestamp:Date.now(),retries:0}),o.close()}catch(e){console.error("[SW] Failed to add to sync queue:",e)}}("POST"===e.method?"create":"DELETE"===e.method?"delete":"update",o,t),"sync"in self.registration&&await self.registration.sync.register("background-sync"),new Response(JSON.stringify({success:!0,message:"Opération enregistrée. Elle sera synchronisée dès que vous serez en ligne.",queued:!0}),{status:202,headers:{"Content-Type":"application/json"}})}catch(e){return new Response(JSON.stringify({error:"Offline",message:"Impossible d'enregistrer l'opération hors ligne."}),{status:503,headers:{"Content-Type":"application/json"}})}}(e.request))})})()})();